import{E as e}from"./event-D9qopLdr.js";import{buf2json as t,json2buf as s,bin2hex as n,str2buf as r,buf2str as i,buf2bin as a}from"./data.js";function o(){return"undefined"!=typeof hmApp}function d(e){return"object"==typeof e&&!Buffer.isBuffer(e)&&!Array.isArray(e)&&null!==e}function h(){return"undefined"!=typeof timer}function p(e){throw new Error(e+" is only avalaible in API_LEVEL 3.0+")}function c(){const e={canceled:!1};return e.promise=new Promise(((t,s)=>{e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}const u="json",l="text",y="bin";function f(e){switch(e.toLowerCase()){case u:return 2;case l:return 1;case y:return 3;case"empty":return 0;default:return 3}}let g=1e4;function I(){return g++}let T=1e3;function m(){return T++}class b extends e{constructor(e,t,s){super(),this.id=e,this.type=t,this.ctx=s,this.logger=s.logger,this.chunks=[],this.count=-1,this.finishChunk=null}addChunk(e){if(1===e.opCode&&(this.count=e.seqId+1,this.finishChunk=e),e.payloadLength!==e.payload.byteLength)return this.logger.error("receive chunk data length error, expect %d but %d",e.payloadLength,e.payload.byteLength),void this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.byteLength}`));this.chunks.push(e),this.checkIfReceiveAllChunks()}checkIfReceiveAllChunks(){if(this.count!==this.chunks.length)return;if(!this.finishChunk)return;let e=[];for(let t=0;t<this.count;t++){const s=this.chunks[t];if(!s||s.seqId!==t)return e=null,this.releaseBuf(),void this.emit("error",Error("receive data error"));e.push(s.payload)}if(this.chunks=[],this.finishChunk.payload=Buffer.concat(e),e=null,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength!==this.finishChunk.payloadLength)return this.logger.error("receive full data length error, expect %d but %d",this.finishChunk.payloadLength,this.finishChunk.payload.byteLength),void this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`));this.emit("data",this.finishChunk)}releaseBuf(){this.chunks=[],this.finishChunk=null,this.count=0}}class k{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s){const n=new b(e,t,s);return this.sessions.set(this.key(n),n),n}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}const S={SUCCESS:0,SHAKE_TIME_OUT:1,BLE_CLOSE:2,APP_CLOSE:3,REQUEST_TIME_OUT:4};class L extends Error{constructor(e,t){super(t),this.code=e}}class w extends e{constructor({appId:e=0,appDevicePort:t=20,appSidePort:s=0,ble:n,logger:r}={appId:0,appDevicePort:20,appSidePort:0,ble:void 0,logger:void 0}){super(),this.isDevice=o(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=s,this.ble=n,this.logger=r,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new k,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=c(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=setTimeout((()=>{this.shakeStatus=4,this.shakeTask.reject(new L(S.SHAKE_TIME_OUT,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&clearTimeout(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return t(e)}json2Buf(e){return s(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{this.logger.warn("[RAW] [R] receive index=>%d size=>%d bin=>%s",e,s,n(t)),this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.logger.debug("app ble disconnect"),this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.logger.warn("[RAW] [R] receive size=>%d bin=>%s",e.byteLength,n(e)),this.onMessage(e)})),this.waitingShakePromise=Promise.resolve(),e&&e(this)}buildBin(e){if(e.payload.byteLength>this.chunkSize)throw new Error(`${e.payload.byteLength} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.byteLength,s=Buffer.alloc(t);let n=0;return s.writeUInt8(e.flag,n),n+=1,s.writeUInt8(e.version,n),n+=1,s.writeUInt16LE(e.type,n),n+=2,s.writeUInt16LE(e.port1,n),n+=2,s.writeUInt16LE(e.port2,n),n+=2,s.writeUInt32LE(e.appId,n),n+=4,s.writeUInt32LE(e.extra,n),n+=4,s.fill(e.payload,n,e.payload.byteLength+n),s}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendShake(){this.logger.info("shake send");const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendClose(){this.logger.info("close send");const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=Buffer.from(e);let s=0;const n=t.readUInt8(s);s+=1;const r=t.readUInt8(s);s+=1;const i=t.readUInt16LE(s);s+=2;const a=t.readUInt16LE(s);s+=2;const o=t.readUInt16LE(s);s+=2;const d=t.readUInt32LE(s);s+=4;const h=t.readUInt32LE(s);return s+=4,{flag:n,version:r,type:i,port1:a,port2:o,appId:d,extra:h,payload:t.subarray(s)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=!0){if(t&&this.logger.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,n(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=!0){t&&this.logger.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,n(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:s,contentType:n,dataType:r},{messageType:i=4}={}){const a=3518,o=t.byteLength;let d=0;const h=Buffer.alloc(a),p=e||I(),c=m();let u=0;const l=Math.ceil(o/a);function y(){return u++}for(let e=1;e<=l;e++){if(this.errorIfBleDisconnect(),e===l){const e=o-d,a=Buffer.alloc(0+e);t.copy(a,0,d,d+e),d+=e,this.sendDataWithSession({traceId:p,spanId:c,seqId:y(),payload:a,type:s,opCode:1,totalLength:o,contentType:n,dataType:r},{messageType:i});break}t.copy(h,0,d,d+a),d+=a,this.sendDataWithSession({traceId:p,spanId:c,seqId:y(),payload:h,type:s,opCode:0,totalLength:o,contentType:n,dataType:r},{messageType:i})}d===o?this.logger.debug("HmProtocol send ok msgSize=> %d dataSize=> %d",d,o):this.logger.error("HmProtocol send error msgSize=> %d dataSize=> %d",d,o)}sendJson({requestId:e=0,json:t,type:n=1,contentType:r,dataType:i}){const a=s(t),o=e||I();this.sendHmProtocol({requestId:o,dataBin:a,type:n,contentType:r,dataType:i})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:r}){const i=e||I();return this.sendHmProtocol({requestId:i,dataBin:t,type:s,contentType:n,dataType:r})}sendText({requestId:e=0,text:t,type:s=1,contentType:n,dataType:i}){const a=r(t),o=e||I();return this.sendHmProtocol({requestId:o,dataBin:a,type:s,contentType:n,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:r,opCode:i,totalLength:a,contentType:o,dataType:d},{messageType:h}){const p=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:a,type:r,opCode:i,payload:n,contentType:o,dataType:d}),c=this.isDevice?this.buildData(p,{type:h}):p;this.sendMsg(c)}buildPayload(e){const t=66+e.payload.byteLength,s=Buffer.alloc(t);let n=0;return s.writeUInt32LE(e.traceId,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(e.spanId,n),n+=4,s.writeUInt32LE(e.seqId,n),n+=4,s.writeUInt32LE(e.totalLength,n),n+=4,s.writeUInt32LE(e.payload.byteLength,n),n+=4,s.writeUInt8(e.type,n),n+=1,s.writeUInt8(e.opCode,n),n+=1,s.writeUInt32LE(this.now(),n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt8(e.contentType,n),n+=1,s.writeUInt8(e.dataType,n),n+=1,s.writeUInt16LE(0,n),n+=2,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.fill(e.payload,n,e.payload.byteLength+n),s}readPayload(e){const t=Buffer.from(e);let s=0;const n=t.readUInt32LE(s);s+=4;const r=t.readUInt32LE(s);s+=4;const i=t.readUInt32LE(s);s+=4;const a=t.readUInt32LE(s);s+=4;const o=t.readUInt32LE(s);s+=4;const d=t.readUInt32LE(s);s+=4;const h=t.readUInt8(s);s+=1;const p=t.readUInt8(s);s+=1;const c=t.readUInt32LE(s);s+=4;const u=t.readUInt32LE(s);s+=4;const l=t.readUInt32LE(s);s+=4;const y=t.readUInt32LE(s);s+=4;const f=t.readUInt32LE(s);s+=4;const g=t.readUInt32LE(s);s+=4;const I=t.readUInt32LE(s);s+=4;const T=t.readUInt8(s);s+=1;const m=t.readUInt8(s);s+=1;const b=t.readUInt16LE(s);s+=2;const k=t.readUInt32LE(s);s+=4;const S=t.readUInt32LE(s);return s+=4,{traceId:n,parentId:r,spanId:i,seqId:a,totalLength:o,payloadLength:d,payloadType:h,opCode:p,contentType:T,dataType:m,timestamp1:c,timestamp2:u,timestamp3:l,timestamp4:y,timestamp5:f,timestamp6:g,timestamp7:I,extra1:b,extra2:k,extra3:S,payload:t.subarray(s)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),this.logger.debug("receive data=>",JSON.stringify(t)),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.logger.debug("shake success appSidePort=>",t.port2),this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag?this.logger.debug("receive runtime => flag %d type %d",t.flag,t.type):1===t.flag&&2===t.type?(this.appSidePort=0,this.logger.debug("receive close =>",this.appSidePort)):this.logger.error("error appSidePort=>%d data=>%j",this.appSidePort,t)}errorIfBleDisconnect(){if(o()&&!this.ble.connectStatus())throw new L(S.BLE_CLOSE,"ble disconnect")}errorIfSideServiceDisconnect(){if(o()&&!this.appSidePort)throw new L(S.APP_CLOSE,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:s})=>{s=void 0===s?e.dataType:f(s),this.response({requestId:e.traceId,contentType:e.contentType,dataType:s,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(e,s){try{this.errorIfBleDisconnect()}catch(e){return Promise.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let n=y;"string"==typeof e?n=l:d(e)?n=u:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(n=y);const r={timeout:6e4,contentType:n,dataType:n},a=I(),o=c();s=Object.assign(r,s);let h=setTimeout((()=>{h=null,o.reject(new L(S.TIMEOUT,"request timeout"))}),s.timeout);return this.handlers.set(a,(({traceId:s,payload:n,dataType:r})=>{let d;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),this.logger.debug("traceId=>%d payload=>%s",s,n.toString("hex")),r){case 1:d=i(n);break;case 3:default:d=n;break;case 2:d=t(n)}this.logger.debug("request id=>%d payload=>%j",a,e),this.logger.debug("response id=>%d payload=>%j",a,d),o.resolve(d)})),Buffer.isBuffer(e)?this.sendBuf({requestId:a,buf:e,type:1,contentType:3,dataType:f(s.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:a,buf:Buffer.from(e),type:1,contentType:3,dataType:f(s.dataType)}):2===f(s.contentType)?this.sendJson({requestId:a,json:e,type:1,contentType:2,dataType:f(s.dataType)}):1===f(s.contentType)?this.sendText({requestId:a,text:e,type:1,contentType:1,dataType:f(s.dataType)}):this.sendBuf({requestId:a,buf:Buffer.from(e),type:1,contentType:3,dataType:f(s.dataType)}),o.promise.catch((e=>{throw this.logger.error("error %j",e),e})).finally((()=>{this.logger.debug("release request id=>%d",a),h&&(clearTimeout(h),h=null),this.handlers.delete(a)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){3===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):1===s?this.sendText({requestId:e,text:n,type:2,contentType:t,dataType:s}):2===s?this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s}):this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:3})}call(e){let t=2;return"string"==typeof e?t=1:d(e)?t=2:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(t=3),this.waitingShakePromise.then((()=>Buffer.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:3,dataType:0}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0}):2===t?this.sendJson({json:e,type:3,contentType:2,dataType:0}):1===t?this.sendText({text:e,type:3,contentType:1,dataType:0}):this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0})))}}const B="hmrpcv1";function E(e,s){return{shakeTimeout:5e3,requestTimeout:6e4,transport:e,onCall(s){return s?(e.on("call",(({contentType:e,payload:n})=>{switch(e){case 2:n=t(n);break;case 1:n=i(n);break;default:n=a(n)}s&&s(n)})),this):this},offOnCall(t){return e.off("call",t),this},call(t){return o()&&e.fork(this.shakeTimeout),t=d(t)?t.contentType?t:{jsonrpc:B,...t}:t,e.call(t)},onRequest(s){return s?(e.on("request",(e=>{let{payload:n}=e.request;switch(e.request.contentType){case 2:n=t(n);break;case 1:n=i(n);break;default:n=a(n)}s&&s(n,((t,s,r={})=>2===e.request.contentType&&n?.jsonrpc===B?t?e.response({data:{jsonrpc:B,error:t}}):e.response({data:{jsonrpc:B,result:s}}):e.response({data:s,...r})))})),this):this},cancelAllRequest(){return e.off("response"),this},offOnRequest(t){return e.off("request",t),this},request(t,n={}){return o()&&e.fork(this.shakeTimeout),s.debug("current request count=>%d",e.getRequestCount()),t=d(t)?n.contentType?t:{jsonrpc:B,...t}:t,e.request(t,{timeout:this.requestTimeout,...n}).then((e=>{if(!d(e)||e.jsonrpc!==B)return e;const{error:t,result:s}=e;if(t)throw t;return s}))},connect(){return e.connect((()=>{s.debug("DeviceApp messageBuilder connect with SideService")})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{s.debug("DeviceApp messageBuilder disconnect SideService")})),this},start(){return e.listen((()=>{s.debug("SideService messageBuilder start to listen to DeviceApp")})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{s.debug("SideService messageBuilder stop to listen to DeviceApp")})),this}}}export{w as M,h as i,p as n,E as w};
